<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="recuperarsenha.css">
  <link rel="icon" type="image/png" href="../IMG/Logo Instituto Alma.png">
  <title>Recuperar Senha</title>
</head>
<body>
  <a href="Login.html" class="home-icon-fixed" aria-label="Ir para Início" title="Início">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z" fill="currentColor"/>
    </svg>
  </a>

  <div class="container">
    <div class="logo-section">
      <h1>Recuperar Senha</h1>
      <p id="stepDescription">Informe seu e-mail cadastrado para redefinir sua senha</p>
    </div>

    <div class="steps">
      <div class="step active" id="step1"></div>
      <div class="step" id="step2"></div>
    </div>

    <!-- ETAPA 1: Verificar e-mail -->
    <form id="emailForm" class="form-step">
      <div class="form-group">
        <label for="email">E-mail</label>
        <input type="email" id="email" placeholder="seu@email.com" required />
      </div>
      <button type="submit">Verificar E-mail</button>
      <div id="emailAlert" class="alert"></div>
    </form>

    <!-- ETAPA 2: Nova senha -->
    <form id="passwordForm" class="form-step hidden">
      <div class="form-group">
        <label for="newPassword">Nova Senha</label>
        <input type="password" id="newPassword" placeholder="Digite sua nova senha" required />
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirmar Senha</label>
        <input type="password" id="confirmPassword" placeholder="Confirme sua nova senha" required />
      </div>
      <button type="submit">Redefinir Senha</button>
      <div id="passwordAlert" class="alert"></div>
    </form>

    <a href="./Login.html" class="back-link">← Voltar para Login</a>
  </div>

  <script>
    let currentStep = 1;
    let userEmail = '';

    // Função auxiliar para mostrar alertas
    function showAlert(element, message, type) {
      element.textContent = message;
      element.className = `alert show ${type}`;
      setTimeout(() => {
        element.classList.remove('show');
      }, 4000);
    }

    // Atualizar UI das etapas
    function updateSteps(step) {
      currentStep = step;
      
      // Atualizar indicadores de progresso
      for (let i = 1; i <= 2; i++) {
        const stepEl = document.getElementById(`step${i}`);
        if (i <= step) {
          stepEl.classList.add('active');
        } else {
          stepEl.classList.remove('active');
        }
      }

      // Atualizar descrição
      const descriptions = {
        1: 'Informe seu e-mail cadastrado para redefinir sua senha',
        2: 'Crie uma nova senha para sua conta'
      };
      document.getElementById('stepDescription').textContent = descriptions[step];

      // Mostrar formulário correto
      document.getElementById('emailForm').classList.toggle('hidden', step !== 1);
      document.getElementById('passwordForm').classList.toggle('hidden', step !== 2);
    }

    // ETAPA 1: Verificar se e-mail existe
    document.getElementById('emailForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailAlert = document.getElementById('emailAlert');
      userEmail = document.getElementById('email').value;

      try {
        // Buscar usuário pelo e-mail
        const res = await fetch(`http://localhost:5104/api/Usuario/email/${encodeURIComponent(userEmail)}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
          const userData = await res.json();
          // E-mail existe, pode prosseguir para trocar senha
          showAlert(emailAlert, '✅ E-mail encontrado!', 'success');
          setTimeout(() => {
            updateSteps(2);
          }, 1500);
        } else {
          showAlert(emailAlert, '❌ E-mail não encontrado no sistema.', 'error');
        }
      } catch (err) {
        showAlert(emailAlert, '⚠️ Erro de conexão: ' + err.message, 'error');
      }
    });

    // ETAPA 2: Redefinir senha
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const passwordAlert = document.getElementById('passwordAlert');
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validar se as senhas coincidem
      if (newPassword !== confirmPassword) {
        showAlert(passwordAlert, '⚠️ As senhas não coincidem.', 'error');
        return;
      }

      // Validar tamanho mínimo da senha
      if (newPassword.length < 6) {
        showAlert(passwordAlert, '⚠️ A senha deve ter no mínimo 6 caracteres.', 'error');
        return;
      }

      try {
        // Fazer update da senha no banco de dados
        const res = await fetch(`http://localhost:5104/api/Usuario/reset-senha/${encodeURIComponent(userEmail)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: userEmail, 
            novaSenha: newPassword 
          })
        });

        if (res.ok) {
          showAlert(passwordAlert, '✅ Senha redefinida com sucesso!', 'success');
          setTimeout(() => {
            window.location.href = '../LOGIN-CADASTRO/Login.html';
          }, 2000);
        } else {
          const json = await res.json();
          showAlert(passwordAlert, json.message || '❌ Erro ao redefinir senha.', 'error');
        }
      } catch (err) {
        showAlert(passwordAlert, '⚠️ Erro de conexão: ' + err.message, 'error');
      }
    });
  </script>
</body>
</html>